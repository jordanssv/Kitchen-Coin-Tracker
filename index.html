<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoonTracker Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Gradient for Fear & Greed Meter */
        .fng-gradient {
            background: linear-gradient(90deg, 
                #ef4444 0%,   /* Red (Extreme Fear) */
                #f97316 25%,  /* Orange (Fear) */
                #eab308 50%,  /* Yellow (Neutral) */
                #84cc16 75%,  /* Lime (Greed) */
                #22c55e 100%  /* Green (Extreme Greed) */
            );
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-gray-800 border-b border-gray-700 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-gray-700 p-2 rounded-lg text-2xl leading-none">
                        ðŸŒš
                    </div>
                    <span class="font-bold text-xl tracking-tight">MoonTracker</span>
                </div>
                <div class="flex items-center gap-4">
                    <span id="next-update" class="text-xs text-gray-400 hidden sm:block">Next update in: 5m</span>
                    <button onclick="manualRefresh()" class="p-2 rounded-full hover:bg-gray-700 transition-colors text-blue-400" title="Refresh Data">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-8 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-bold mb-2">Market Overview</h1>
                <p class="text-gray-400">Live prices via CoinGecko</p>
            </div>
        </div>

        <div id="error-container" class="hidden mb-6 bg-red-900/50 border border-red-500/50 text-red-200 px-4 py-3 rounded-lg flex items-center gap-3" role="alert">
            <i class="fa-solid fa-circle-exclamation"></i>
            <div>
                <span class="font-bold">Error:</span>
                <span id="error-message">Something went wrong.</span>
            </div>
        </div>

        <!-- COIN TABLE -->
        <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden shadow-2xl mb-8">
            <div class="overflow-x-auto scrollbar-hide">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-750 text-gray-400 text-sm uppercase tracking-wider border-b border-gray-700">
                            <th class="p-4 font-semibold">Asset</th>
                            <th class="p-4 font-semibold text-right">Price</th>
                            <th class="p-4 font-semibold text-right">24h Change</th>
                            <th class="p-4 font-semibold text-right hidden md:table-cell">Market Cap</th>
                            <th class="p-4 font-semibold text-right hidden lg:table-cell">24h Volume</th>
                            <th class="p-4 font-semibold text-right hidden sm:table-cell">Last 7 Days</th>
                        </tr>
                    </thead>
                    <tbody id="coin-table-body" class="divide-y divide-gray-700 text-sm">
                        <!-- Skeletons -->
                        <tr class="animate-pulse">
                            <td class="p-4"><div class="h-4 bg-gray-700 rounded w-32"></div></td>
                            <td class="p-4"><div class="h-4 bg-gray-700 rounded w-20 ml-auto"></div></td>
                            <td class="p-4"><div class="h-4 bg-gray-700 rounded w-16 ml-auto"></div></td>
                            <td class="p-4 hidden md:table-cell"><div class="h-4 bg-gray-700 rounded w-24 ml-auto"></div></td>
                            <td class="p-4 hidden lg:table-cell"><div class="h-4 bg-gray-700 rounded w-24 ml-auto"></div></td>
                            <td class="p-4 hidden sm:table-cell"><div class="h-4 bg-gray-700 rounded w-24 ml-auto"></div></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- FEAR & GREED METER -->
        <div class="bg-gray-800 rounded-xl border border-gray-700 p-6 shadow-xl">
            <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                <!-- Text Info -->
                <div class="text-center md:text-left">
                    <h2 class="text-lg font-semibold text-gray-200 mb-1">Crypto Fear & Greed Index</h2>
                    <p class="text-sm text-gray-400">Global Market Sentiment</p>
                </div>

                <!-- Value Display -->
                <div class="text-center">
                    <div class="flex items-center justify-center gap-2">
                        <span id="fng-value" class="text-4xl font-bold text-gray-100">--</span>
                    </div>
                    <div id="fng-text" class="text-sm font-medium uppercase tracking-wide text-gray-500 mt-1">Loading...</div>
                </div>

                <!-- The Meter -->
                <div class="w-full md:w-1/2 lg:w-1/3">
                    <div class="relative h-10 flex items-center">
                        <!-- The Bar -->
                        <div class="w-full h-4 rounded-full fng-gradient opacity-80 shadow-inner"></div>
                        
                        <!-- The Emoji Marker (Absolute) -->
                        <div id="fng-marker" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-3xl transition-all duration-1000 ease-out filter drop-shadow-lg" style="left: 50%">
                            ðŸŒ“
                        </div>
                    </div>
                    <!-- Legend Text -->
                    <div class="flex justify-between text-xs text-gray-500 font-mono">
                        <span>Fear (0)</span>
                        <span>Neutral (50)</span>
                        <span>Greed (100)</span>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- CONFIGURATION ---
        
        // SET TO TRUE FOR VERCEL DEPLOYMENT
        const USE_PROXY = true; 
        
        // Local fallback key (Only used if USE_PROXY = false)
        const DIRECT_API_KEY = ""; 

        const REFRESH_INTERVAL = 300000; // 5 Minutes

        const orderedCoinIds = [
            'bitcoin', 'ethereum', 'solana', 'lido-dao', 'ether-fi', 
            'celestia', 'eigencloud', 'ssv-network', 'rocket-pool', 'obol-2'
        ];

        // --- FETCH LOGIC ---
        async function fetchData() {
            const tableBody = document.getElementById('coin-table-body');
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.getElementById('error-message');
            const refreshBtn = document.querySelector('.fa-rotate');

            refreshBtn.classList.add('fa-spin');
            
            try {
                // 1. Fetch Coins
                let data;
                if (USE_PROXY) {
                    const response = await fetch('/api/stats');
                    if (!response.ok) throw new Error("Failed to fetch data. Ensure your API key is set in Vercel.");
                    data = await response.json();
                } else {
                    if (!DIRECT_API_KEY) throw new Error("No API Key provided for direct access.");
                    const coinsParam = orderedCoinIds.join(',');
                    const url = `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${coinsParam}&order=market_cap_desc&sparkline=true&price_change_percentage=24h&x_cg_demo_api_key=${DIRECT_API_KEY}`;
                    
                    const response = await fetch(url);
                    if (!response.ok) {
                        if (response.status === 429) throw new Error("Rate limit exceeded. Please wait.");
                        throw new Error(`API Error: ${response.statusText}`);
                    }
                    data = await response.json();
                }

                // 2. Render Table
                errorContainer.classList.add('hidden');
                tableBody.innerHTML = ''; 
                const coinMap = new Map(data.map(coin => [coin.id, coin]));
                orderedCoinIds.forEach(id => {
                    const coin = coinMap.get(id);
                    if (coin) renderRow(coin, tableBody);
                });

                // 3. Fetch Sentiment (Fear & Greed)
                fetchSentiment();

                resetTimer();

            } catch (error) {
                console.error(error);
                errorMessage.innerText = error.message;
                errorContainer.classList.remove('hidden');
            } finally {
                refreshBtn.classList.remove('fa-spin');
            }
        }

        async function fetchSentiment() {
            try {
                let json;
                if (USE_PROXY) {
                    const res = await fetch('/api/sentiment');
                    if (!res.ok) throw new Error("Proxy error");
                    json = await res.json();
                } else {
                    const res = await fetch('https://api.alternative.me/fng/?limit=1');
                    json = await res.json();
                }
                
                const item = json.data[0];
                const value = parseInt(item.value);
                const text = item.value_classification;

                // Update UI
                const valEl = document.getElementById('fng-value');
                const textEl = document.getElementById('fng-text');
                const markerEl = document.getElementById('fng-marker');

                valEl.innerText = value;
                textEl.innerText = text;

                // Moon Phase Logic (Ranges: 0-24, 25-44, 45-54, 55-74, 75-100)
                let moonEmoji = 'ðŸŒ“';
                let colorClass = 'text-yellow-400';

                if (value < 25) {
                    moonEmoji = 'ðŸŒš'; // Extreme Fear
                    colorClass = 'text-red-500';
                } else if (value < 45) {
                    moonEmoji = 'ðŸŒ’'; // Fear
                    colorClass = 'text-orange-400';
                } else if (value < 55) {
                    moonEmoji = 'ðŸŒ“'; // Neutral
                    colorClass = 'text-yellow-400';
                } else if (value < 75) {
                    moonEmoji = 'ðŸŒ”'; // Greed
                    colorClass = 'text-lime-400';
                } else {
                    moonEmoji = 'ðŸŒ'; // Extreme Greed
                    colorClass = 'text-green-500';
                }

                // Update text color
                textEl.className = `text-sm font-bold uppercase tracking-wide ${colorClass} mt-1`;

                // Update Marker Emoji and Position
                markerEl.innerText = moonEmoji;
                markerEl.style.left = `${value}%`;

            } catch (e) {
                console.warn("Failed to fetch Fear & Greed index", e);
                document.getElementById('fng-text').innerText = "Unavailable";
                document.getElementById('fng-value').innerText = "--";
            }
        }

        function renderRow(coin, container) {
            const priceChange = coin.price_change_percentage_24h;
            const isPositive = priceChange >= 0;
            const colorClass = isPositive ? 'text-green-400' : 'text-red-400';
            const iconClass = isPositive ? 'fa-caret-up' : 'fa-caret-down';
            const sparklineColor = isPositive ? '#4ade80' : '#f87171';
            const sparklineSvg = generateSparkline(coin.sparkline_in_7d?.price, sparklineColor);

            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-750 transition-colors border-b border-gray-700/50 fade-in';
            row.innerHTML = `
                <td class="p-4">
                    <div class="flex items-center gap-3">
                        <img src="${coin.image}" alt="${coin.name}" class="w-8 h-8 rounded-full shadow-sm bg-gray-700" onerror="this.src='https://placehold.co/32x32/gray/white?text=?'">
                        <div class="flex flex-col">
                            <span class="font-bold text-gray-100">${coin.name}</span>
                            <span class="text-xs text-gray-500 uppercase">${coin.symbol}</span>
                        </div>
                    </div>
                </td>
                <td class="p-4 text-right font-medium text-gray-100">
                    ${formatCurrency(coin.current_price)}
                </td>
                <td class="p-4 text-right">
                    <div class="flex items-center justify-end gap-1 ${colorClass}">
                        <i class="fa-solid ${iconClass} text-xs"></i>
                        <span class="font-bold">${formatPercentage(priceChange)}</span>
                    </div>
                </td>
                <td class="p-4 text-right text-gray-400 hidden md:table-cell font-mono text-sm">
                    ${formatCompactNumber(coin.market_cap)}
                </td>
                <td class="p-4 text-right text-gray-400 hidden lg:table-cell font-mono text-sm">
                    ${formatCompactNumber(coin.total_volume)}
                </td>
                 <td class="p-4 hidden sm:table-cell w-32">
                    ${sparklineSvg}
                </td>
            `;
            container.appendChild(row);
        }

        // --- UTILITIES ---
        const formatCurrency = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: num < 1 ? 4 : 2 }).format(num);
        const formatCompactNumber = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', notation: 'compact' }).format(num);
        const formatPercentage = (num) => num ? `${num.toFixed(2)}%` : '0.00%';

        function generateSparkline(data, color) {
            if (!data || data.length === 0) return '';
            const width = 120, height = 40;
            const min = Math.min(...data), max = Math.max(...data), range = max - min || 1;
            const points = data.map((p, i) => `${(i / (data.length - 1)) * width},${height - ((p - min) / range) * height}`).join(' ');
            return `<svg width="${width}" height="${height}" fill="none"><polyline points="${points}" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        }

        // --- TIMER LOGIC ---
        let nextFetchTime = Date.now() + REFRESH_INTERVAL;
        let timerInterval;

        function updateTimerDisplay() {
            const now = Date.now();
            const diff = Math.max(0, nextFetchTime - now);
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            document.getElementById('next-update').innerText = `Next update: ${minutes}m ${seconds}s`;
            
            if (diff <= 0) {
                fetchData();
            }
        }

        function resetTimer() {
            nextFetchTime = Date.now() + REFRESH_INTERVAL;
        }

        function manualRefresh() {
            fetchData();
            resetTimer(); 
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            timerInterval = setInterval(updateTimerDisplay, 1000);
        });

    </script>
</body>
</html>
